<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GPU Shadow + HDRI + GUI</title>
  <style>body{margin:0;overflow:hidden}</style>
</head>
<body>
  <!-- three.js core + extras -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/dat.gui.min.js"></script>

  <script>
  // ---------------- Renderer ----------------
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  // สำคัญ: ให้สี/โทนถูกต้อง
  renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;

  document.body.appendChild(renderer.domElement);

  // ---------------- Scene & Camera ----------------
  const scene = new THREE.Scene();

  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 2, 5);
  const controls = new THREE.OrbitControls(camera, renderer.domElement);

  // ---------------- Lights ----------------
  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(5, 10, 5);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.set(2048, 2048);
  dirLight.shadow.camera.near = 0.5;
  dirLight.shadow.camera.far = 50;
  dirLight.shadow.camera.left = -10;
  dirLight.shadow.camera.right = 10;
  dirLight.shadow.camera.top = 10;
  dirLight.shadow.camera.bottom = -10;
  // ลดปัญหา shadow acne
  dirLight.shadow.bias = -0.0005;
  dirLight.shadow.normalBias = 0.02;
  scene.add(dirLight);

  scene.add(new THREE.AmbientLight(0x404040, 0.5));

  const spotLight = new THREE.SpotLight(0xffffff, 1);
  spotLight.position.set(2, 5, 2);
  spotLight.angle = Math.PI/6;
  spotLight.penumbra = 0.2;
  spotLight.castShadow = true;
  scene.add(spotLight);

  // ---------------- HDRI Environment + Background ----------------
  const pmrem = new THREE.PMREMGenerator(renderer);
  pmrem.compileEquirectangularShader();

  new THREE.RGBELoader()
    .setDataType(THREE.UnsignedByteType)
    .load(
      // Poly Haven (CORS OK)
      "https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/empty_play_room_1k.hdr",
      (hdr) => {
        const envMap = pmrem.fromEquirectangular(hdr).texture;
        scene.environment = envMap;   // ใช้เป็น IBL
        scene.background  = envMap;   // โชว์เป็นพื้นหลังด้วย
        hdr.dispose();
        pmrem.dispose();
      }
    );

  // ---------------- Ground ----------------
  const texLoader = new THREE.TextureLoader();
  const groundTex = texLoader.load(
    "https://raw.githubusercontent.com/sitapich-t/icg/main/checkered_pavement_tiles_diff_1k.jpg",
    (t) => {
      t.wrapS = t.wrapT = THREE.RepeatWrapping;
      t.repeat.set(4,4);
      t.encoding = THREE.sRGBEncoding; // baseColor ต้อง sRGB
    }
  );

  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(30, 30),
    new THREE.MeshStandardMaterial({ map: groundTex, roughness: 0.7, metalness: 0.2 })
  );
  plane.rotation.x = -Math.PI/2;
  plane.receiveShadow = true;
  scene.add(plane);

  // ---------------- OBJ Model ----------------
  const objBase = texLoader.load(
    "https://raw.githubusercontent.com/sitapich-t/icg/main/mat0_baseColor.png",
    (t)=>{ t.encoding = THREE.sRGBEncoding; }
  );

  const objBase2 = texLoader.load(
    "https://raw.githubusercontent.com/sitapich-t/icg/main/mat0.004_baseColor.png",
    (t)=>{ t.encoding = THREE.sRGBEncoding; }
  );

  const objLoader = new THREE.OBJLoader();
  objLoader.load("https://sitapich-t.github.io/icg/rifle.obj", (object) => {
    object.traverse((child) => {
      if (child.isMesh) {
        child.material = new THREE.MeshStandardMaterial({
          map: objBase,
          normalMap: objBase2,
          metalness: 1.0,     // ให้เห็น reflection จาก HDRI ชัด
          roughness: 0.35,
          envMapIntensity: 1.0
        });
        child.castShadow = true;
        child.receiveShadow = true;
      }
    });
    object.position.y = 0;
    object.position.x = -3;
    scene.add(object);
  });

  // ---------------- GUI ----------------
  const gui = new dat.GUI();
  const f1 = gui.addFolder("Directional Light");
  f1.add(dirLight, "intensity", 0, 2, 0.01);
  f1.add(dirLight.position, "x", -10, 10, 0.1);
  f1.add(dirLight.position, "y", 0, 20, 0.1);
  f1.add(dirLight.position, "z", -10, 10, 0.1);

  const f2 = gui.addFolder("Spot Light");
  f2.add(spotLight, "intensity", 0, 2, 0.01);
  f2.add(spotLight, "angle", 0, Math.PI/2, 0.01);
  f2.add(spotLight.position, "x", -10, 10, 0.1);
  f2.add(spotLight.position, "y", 0, 20, 0.1);
  f2.add(spotLight.position, "z", -10, 10, 0.1);

  gui.add(renderer, "toneMappingExposure", 0.1, 2.0, 0.01).name("Exposure");
  gui.add(plane.material, "roughness", 0, 1, 0.01);
  gui.add(plane.material, "metalness", 0, 1, 0.01);

  const envCtl = { intensity: 1.0 };
  gui.add(envCtl, "intensity", 0, 3, 0.05).name("EnvMap Intensity").onChange(v=>{
    scene.traverse(o=>{
      if (o.isMesh && o.material && "envMapIntensity" in o.material) {
        o.material.envMapIntensity = v;
        o.material.needsUpdate = true;
      }
    });
  });

  // ---------------- Animate & Resize ----------------
  function animate(){ renderer.render(scene, camera); requestAnimationFrame(animate); }
  animate();

  window.addEventListener("resize", ()=>{
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
  </script>
</body>
</html>
